{"version":3,"sources":["../../../../../../src/client/components/react-dev-overlay/internal/helpers/use-error-handler.ts"],"sourcesContent":["import { useEffect } from 'react'\nimport { attachHydrationErrorState } from './attach-hydration-error-state'\nimport { isNextRouterError } from '../../../is-next-router-error'\nimport { storeHydrationErrorStateFromConsoleArgs } from './hydration-error-info'\nimport { formatConsoleArgs } from '../../../../lib/console'\nimport isError from '../../../../../lib/is-error'\nimport { ConsoleError } from './console-error'\nimport { enqueueConsecutiveDedupedError } from './enqueue-client-error'\n\nexport type ErrorHandler = (error: Error) => void\n\nconst errorQueue: Array<Error> = []\nconst errorHandlers: Array<ErrorHandler> = []\nconst rejectionQueue: Array<Error> = []\nconst rejectionHandlers: Array<ErrorHandler> = []\n\nexport function handleClientError(\n  originError: unknown,\n  consoleErrorArgs: any[]\n) {\n  let error: Error\n  if (!originError || !isError(originError)) {\n    // If it's not an error, format the args into an error\n    const formattedErrorMessage = formatConsoleArgs(consoleErrorArgs)\n    error = new ConsoleError(formattedErrorMessage)\n  } else {\n    error = originError\n  }\n\n  storeHydrationErrorStateFromConsoleArgs(...consoleErrorArgs)\n  attachHydrationErrorState(error)\n\n  enqueueConsecutiveDedupedError(errorQueue, error)\n  for (const handler of errorHandlers) {\n    handler(error)\n  }\n}\n\nexport function useErrorHandler(\n  handleOnUnhandledError: ErrorHandler,\n  handleOnUnhandledRejection: ErrorHandler\n) {\n  useEffect(() => {\n    // Handle queued errors.\n    errorQueue.forEach(handleOnUnhandledError)\n    rejectionQueue.forEach(handleOnUnhandledRejection)\n\n    // Listen to new errors.\n    errorHandlers.push(handleOnUnhandledError)\n    rejectionHandlers.push(handleOnUnhandledRejection)\n\n    return () => {\n      // Remove listeners.\n      errorHandlers.splice(errorHandlers.indexOf(handleOnUnhandledError), 1)\n      rejectionHandlers.splice(\n        rejectionHandlers.indexOf(handleOnUnhandledRejection),\n        1\n      )\n    }\n  }, [handleOnUnhandledError, handleOnUnhandledRejection])\n}\n\nexport function handleGlobalErrors() {\n  if (typeof window !== 'undefined') {\n    try {\n      // Increase the number of stack frames on the client\n      Error.stackTraceLimit = 50\n    } catch {}\n\n    window.addEventListener(\n      'error',\n      (event: WindowEventMap['error']): void | boolean => {\n        if (isNextRouterError(event.error)) {\n          event.preventDefault()\n          return false\n        }\n        handleClientError(event.error, [])\n      }\n    )\n\n    window.addEventListener(\n      'unhandledrejection',\n      (ev: WindowEventMap['unhandledrejection']): void => {\n        const reason = ev?.reason\n        if (isNextRouterError(reason)) {\n          ev.preventDefault()\n          return\n        }\n\n        if (\n          !reason ||\n          !(reason instanceof Error) ||\n          typeof reason.stack !== 'string'\n        ) {\n          // A non-error was thrown, we don't have anything to show. :-(\n          return\n        }\n\n        const e = reason\n        rejectionQueue.push(e)\n        for (const handler of rejectionHandlers) {\n          handler(e)\n        }\n      }\n    )\n  }\n}\n"],"names":["handleClientError","handleGlobalErrors","useErrorHandler","errorQueue","errorHandlers","rejectionQueue","rejectionHandlers","originError","consoleErrorArgs","error","isError","formattedErrorMessage","formatConsoleArgs","ConsoleError","storeHydrationErrorStateFromConsoleArgs","attachHydrationErrorState","enqueueConsecutiveDedupedError","handler","handleOnUnhandledError","handleOnUnhandledRejection","useEffect","forEach","push","splice","indexOf","window","Error","stackTraceLimit","addEventListener","event","isNextRouterError","preventDefault","ev","reason","stack","e"],"mappings":";;;;;;;;;;;;;;;;IAgBgBA,iBAAiB;eAAjBA;;IA8CAC,kBAAkB;eAAlBA;;IAxBAC,eAAe;eAAfA;;;;uBAtCU;2CACgB;mCACR;oCACsB;yBACtB;kEACd;8BACS;oCACkB;AAI/C,MAAMC,aAA2B,EAAE;AACnC,MAAMC,gBAAqC,EAAE;AAC7C,MAAMC,iBAA+B,EAAE;AACvC,MAAMC,oBAAyC,EAAE;AAE1C,SAASN,kBACdO,WAAoB,EACpBC,gBAAuB;IAEvB,IAAIC;IACJ,IAAI,CAACF,eAAe,CAACG,IAAAA,gBAAO,EAACH,cAAc;QACzC,sDAAsD;QACtD,MAAMI,wBAAwBC,IAAAA,0BAAiB,EAACJ;QAChDC,QAAQ,IAAII,0BAAY,CAACF;IAC3B,OAAO;QACLF,QAAQF;IACV;IAEAO,IAAAA,2DAAuC,KAAIN;IAC3CO,IAAAA,oDAAyB,EAACN;IAE1BO,IAAAA,kDAA8B,EAACb,YAAYM;IAC3C,KAAK,MAAMQ,WAAWb,cAAe;QACnCa,QAAQR;IACV;AACF;AAEO,SAASP,gBACdgB,sBAAoC,EACpCC,0BAAwC;IAExCC,IAAAA,gBAAS,EAAC;QACR,wBAAwB;QACxBjB,WAAWkB,OAAO,CAACH;QACnBb,eAAegB,OAAO,CAACF;QAEvB,wBAAwB;QACxBf,cAAckB,IAAI,CAACJ;QACnBZ,kBAAkBgB,IAAI,CAACH;QAEvB,OAAO;YACL,oBAAoB;YACpBf,cAAcmB,MAAM,CAACnB,cAAcoB,OAAO,CAACN,yBAAyB;YACpEZ,kBAAkBiB,MAAM,CACtBjB,kBAAkBkB,OAAO,CAACL,6BAC1B;QAEJ;IACF,GAAG;QAACD;QAAwBC;KAA2B;AACzD;AAEO,SAASlB;IACd,IAAI,OAAOwB,WAAW,aAAa;QACjC,IAAI;YACF,oDAAoD;YACpDC,MAAMC,eAAe,GAAG;QAC1B,EAAE,UAAM,CAAC;QAETF,OAAOG,gBAAgB,CACrB,SACA,CAACC;YACC,IAAIC,IAAAA,oCAAiB,EAACD,MAAMpB,KAAK,GAAG;gBAClCoB,MAAME,cAAc;gBACpB,OAAO;YACT;YACA/B,kBAAkB6B,MAAMpB,KAAK,EAAE,EAAE;QACnC;QAGFgB,OAAOG,gBAAgB,CACrB,sBACA,CAACI;YACC,MAAMC,SAASD,sBAAAA,GAAIC,MAAM;YACzB,IAAIH,IAAAA,oCAAiB,EAACG,SAAS;gBAC7BD,GAAGD,cAAc;gBACjB;YACF;YAEA,IACE,CAACE,UACD,CAAEA,CAAAA,kBAAkBP,KAAI,KACxB,OAAOO,OAAOC,KAAK,KAAK,UACxB;gBACA,8DAA8D;gBAC9D;YACF;YAEA,MAAMC,IAAIF;YACV5B,eAAeiB,IAAI,CAACa;YACpB,KAAK,MAAMlB,WAAWX,kBAAmB;gBACvCW,QAAQkB;YACV;QACF;IAEJ;AACF"}