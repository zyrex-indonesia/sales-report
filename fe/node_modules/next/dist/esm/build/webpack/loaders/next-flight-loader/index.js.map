{"version":3,"sources":["../../../../../src/build/webpack/loaders/next-flight-loader/index.ts"],"sourcesContent":["import type { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { RSC_MOD_REF_PROXY_ALIAS } from '../../../../lib/constants'\nimport {\n  BARREL_OPTIMIZATION_PREFIX,\n  DEFAULT_RUNTIME_WEBPACK,\n  EDGE_RUNTIME_WEBPACK,\n  RSC_MODULE_TYPES,\n} from '../../../../shared/lib/constants'\nimport { warnOnce } from '../../../../shared/lib/utils/warn-once'\nimport { getRSCModuleInformation } from '../../../analysis/get-page-static-info'\nimport { formatBarrelOptimizedResource } from '../../utils'\nimport { getModuleBuildInfo } from '../get-module-build-info'\nimport type {\n  javascript,\n  LoaderContext,\n} from 'next/dist/compiled/webpack/webpack'\nimport picomatch from 'next/dist/compiled/picomatch'\n\nexport interface NextFlightLoaderOptions {\n  isEdgeServer: boolean\n}\n\ntype SourceType = javascript.JavascriptParser['sourceType'] | 'commonjs'\n\nconst noopHeadPath = require.resolve('next/dist/client/components/noop-head')\n// For edge runtime it will be aliased to esm version by webpack\nconst MODULE_PROXY_PATH =\n  'next/dist/build/webpack/loaders/next-flight-loader/module-proxy'\n\nconst isSharedRuntime = picomatch('**/next/dist/**/*.shared-runtime.js', {\n  dot: true, // required for .pnpm paths\n})\n\nexport function getAssumedSourceType(\n  mod: webpack.Module,\n  sourceType: SourceType\n): SourceType {\n  const buildInfo = getModuleBuildInfo(mod)\n  const detectedClientEntryType = buildInfo?.rsc?.clientEntryType\n  const clientRefs = buildInfo?.rsc?.clientRefs || []\n\n  // It's tricky to detect the type of a client boundary, but we should always\n  // use the `module` type when we can, to support `export *` and `export from`\n  // syntax in other modules that import this client boundary.\n  let assumedSourceType = sourceType\n  if (assumedSourceType === 'auto' && detectedClientEntryType === 'auto') {\n    if (\n      clientRefs.length === 0 ||\n      (clientRefs.length === 1 && clientRefs[0] === '')\n    ) {\n      // If there's zero export detected in the client boundary, and it's the\n      // `auto` type, we can safely assume it's a CJS module because it doesn't\n      // have ESM exports.\n      assumedSourceType = 'commonjs'\n    } else if (!clientRefs.includes('*')) {\n      // Otherwise, we assume it's an ESM module.\n      assumedSourceType = 'module'\n    }\n  }\n  return assumedSourceType\n}\n\nexport default function transformSource(\n  this: LoaderContext<NextFlightLoaderOptions>,\n  source: string,\n  sourceMap: any\n) {\n  // Avoid buffer to be consumed\n  if (typeof source !== 'string') {\n    throw new Error('Expected source to have been transformed to a string.')\n  }\n\n  const options = this.getOptions()\n  const { isEdgeServer } = options\n  const module = this._module!\n\n  // Assign the RSC meta information to buildInfo.\n  // Exclude next internal files which are not marked as client files\n  const buildInfo = getModuleBuildInfo(module)\n  buildInfo.rsc = getRSCModuleInformation(source, true)\n\n  // Resource key is the unique identifier for the resource. When RSC renders\n  // a client module, that key is used to identify that module across all compiler\n  // layers.\n  //\n  // Usually it's the module's file path + the export name (e.g. `foo.js#bar`).\n  // But with Barrel Optimizations, one file can be splitted into multiple modules,\n  // so when you import `foo.js#bar` and `foo.js#baz`, they are actually different\n  // \"foo.js\" being created by the Barrel Loader (one only exports `bar`, the other\n  // only exports `baz`).\n  //\n  // Because of that, we must add another query param to the resource key to\n  // differentiate them.\n  let resourceKey: string = this.resourcePath\n  if (module.matchResource?.startsWith(BARREL_OPTIMIZATION_PREFIX)) {\n    resourceKey = formatBarrelOptimizedResource(\n      resourceKey,\n      module.matchResource\n    )\n  }\n\n  // A client boundary.\n  if (buildInfo.rsc?.type === RSC_MODULE_TYPES.client) {\n    const assumedSourceType = getAssumedSourceType(\n      module,\n      (module.parser as javascript.JavascriptParser).sourceType\n    )\n\n    const clientRefs = buildInfo.rsc.clientRefs!\n\n    if (assumedSourceType === 'module') {\n      if (clientRefs.includes('*')) {\n        this.callback(\n          new Error(\n            `It's currently unsupported to use \"export *\" in a client boundary. Please use named exports instead.`\n          )\n        )\n        return\n      }\n\n      if (!isSharedRuntime(resourceKey)) {\n        // Prevent module concatenation, and prevent export names from being\n        // mangled, in production builds, so that exports of client reference\n        // modules can be resolved by React using the metadata from the client\n        // manifest.\n        this._compilation!.moduleGraph.getExportsInfo(\n          module\n        ).setUsedInUnknownWay(\n          isEdgeServer ? EDGE_RUNTIME_WEBPACK : DEFAULT_RUNTIME_WEBPACK\n        )\n      }\n\n      // `proxy` is the module proxy that we treat the module as a client boundary.\n      // For ESM, we access the property of the module proxy directly for each export.\n      // This is bit hacky that treating using a CJS like module proxy for ESM's exports,\n      // but this will avoid creating nested proxies for each export. It will be improved in the future.\n\n      // Explanation for: await createProxy(...)\n      // We need to await the module proxy creation because it can be async module for SSR layer\n      // due to having async dependencies.\n      // We only apply `the await` for Node.js as only Edge doesn't have external dependencies.\n      let esmSource = `\\\nimport { createProxy } from \"${MODULE_PROXY_PATH}\"\n\nconst proxy = ${isEdgeServer ? '' : 'await'} createProxy(String.raw\\`${resourceKey}\\`)\n`\n      let cnt = 0\n      for (const ref of clientRefs) {\n        if (ref === '') {\n          esmSource += `exports[''] = proxy['']\\n`\n        } else if (ref === 'default') {\n          esmSource += `export default proxy.default;\\n`\n        } else {\n          esmSource += `const e${cnt} = proxy[\"${ref}\"];\\n`\n          esmSource += `export { e${cnt++} as ${ref} };\\n`\n        }\n      }\n\n      this.callback(null, esmSource, sourceMap)\n      return\n    }\n  }\n\n  if (buildInfo.rsc?.type !== RSC_MODULE_TYPES.client) {\n    if (noopHeadPath === this.resourcePath) {\n      warnOnce(\n        `Warning: You're using \\`next/head\\` inside the \\`app\\` directory, please migrate to the Metadata API. See https://nextjs.org/docs/app/building-your-application/upgrading/app-router-migration#step-3-migrating-nexthead for more details.`\n      )\n    }\n  }\n\n  const replacedSource = source.replace(\n    RSC_MOD_REF_PROXY_ALIAS,\n    MODULE_PROXY_PATH\n  )\n  this.callback(null, replacedSource, sourceMap)\n}\n"],"names":["RSC_MOD_REF_PROXY_ALIAS","BARREL_OPTIMIZATION_PREFIX","DEFAULT_RUNTIME_WEBPACK","EDGE_RUNTIME_WEBPACK","RSC_MODULE_TYPES","warnOnce","getRSCModuleInformation","formatBarrelOptimizedResource","getModuleBuildInfo","picomatch","noopHeadPath","require","resolve","MODULE_PROXY_PATH","isSharedRuntime","dot","getAssumedSourceType","mod","sourceType","buildInfo","detectedClientEntryType","rsc","clientEntryType","clientRefs","assumedSourceType","length","includes","transformSource","source","sourceMap","module","Error","options","getOptions","isEdgeServer","_module","resourceKey","resourcePath","matchResource","startsWith","type","client","parser","callback","_compilation","moduleGraph","getExportsInfo","setUsedInUnknownWay","esmSource","cnt","ref","replacedSource","replace"],"mappings":"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"}