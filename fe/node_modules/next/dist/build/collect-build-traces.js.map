{"version":3,"sources":["../../src/build/collect-build-traces.ts"],"sourcesContent":["import { Span } from '../trace'\nimport type { NextConfigComplete } from '../server/config-shared'\n\nimport {\n  TRACE_IGNORES,\n  type BuildTraceContext,\n  getFilesMapFromReasons,\n  getHash,\n} from './webpack/plugins/next-trace-entrypoints-plugin'\n\nimport {\n  TRACE_OUTPUT_VERSION,\n  TURBO_TRACE_DEFAULT_MEMORY_LIMIT,\n} from '../shared/lib/constants'\n\nimport path from 'path'\nimport fs from 'fs/promises'\nimport { loadBindings } from './swc'\nimport { nonNullable } from '../lib/non-nullable'\nimport * as ciEnvironment from '../server/ci-info'\nimport debugOriginal from 'next/dist/compiled/debug'\nimport picomatch from 'next/dist/compiled/picomatch'\nimport { defaultOverrides } from '../server/require-hook'\nimport { nodeFileTrace } from 'next/dist/compiled/@vercel/nft'\nimport { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\nimport { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\nimport isError from '../lib/is-error'\nimport type { NodeFileTraceReasons } from '@vercel/nft'\nimport type { RoutesUsingEdgeRuntime } from './utils'\nimport type { ExternalObject, NextTurboTasks } from './swc/generated-native'\n\nconst debug = debugOriginal('next:build:build-traces')\n\nconst hashCache: Record<string, string> = {}\n\nfunction shouldIgnore(\n  file: string,\n  serverIgnoreFn: (file: string) => boolean,\n  reasons: NodeFileTraceReasons,\n  cachedIgnoreFiles: Map<string, boolean>,\n  children: Set<string> = new Set()\n) {\n  if (cachedIgnoreFiles.has(file)) {\n    return cachedIgnoreFiles.get(file)\n  }\n\n  if (serverIgnoreFn(file)) {\n    cachedIgnoreFiles.set(file, true)\n    return true\n  }\n  children.add(file)\n\n  const reason = reasons.get(file)\n  if (!reason || reason.parents.size === 0 || reason.type.includes('initial')) {\n    cachedIgnoreFiles.set(file, false)\n    return false\n  }\n\n  // if all parents are ignored the child file\n  // should be ignored as well\n  let allParentsIgnored = true\n\n  for (const parent of reason.parents.values()) {\n    if (!children.has(parent)) {\n      children.add(parent)\n      if (\n        !shouldIgnore(\n          parent,\n          serverIgnoreFn,\n          reasons,\n          cachedIgnoreFiles,\n          children\n        )\n      ) {\n        allParentsIgnored = false\n        break\n      }\n    }\n  }\n\n  cachedIgnoreFiles.set(file, allParentsIgnored)\n  return allParentsIgnored\n}\n\nexport async function collectBuildTraces({\n  dir,\n  config,\n  distDir,\n  edgeRuntimeRoutes,\n  staticPages,\n  nextBuildSpan = new Span({ name: 'build' }),\n  hasSsrAmpPages,\n  buildTraceContext,\n  outputFileTracingRoot,\n  isFlyingShuttle,\n}: {\n  dir: string\n  distDir: string\n  staticPages: string[]\n  hasSsrAmpPages: boolean\n  isFlyingShuttle?: boolean\n  outputFileTracingRoot: string\n  // pageInfos is serialized when this function runs in a worker.\n  edgeRuntimeRoutes: RoutesUsingEdgeRuntime\n  nextBuildSpan?: Span\n  config: NextConfigComplete\n  buildTraceContext?: BuildTraceContext\n}) {\n  const startTime = Date.now()\n  debug('starting build traces')\n  let turboTasksForTrace: ExternalObject<NextTurboTasks>\n  let bindings = await loadBindings()\n\n  const runTurbotrace = async function () {\n    if (!config.experimental.turbotrace || !buildTraceContext) {\n      return\n    }\n    if (!bindings?.isWasm && typeof bindings.turbo.startTrace === 'function') {\n      let turbotraceOutputPath: string | undefined\n      let turbotraceFiles: string[] | undefined\n      turboTasksForTrace = bindings.turbo.createTurboTasks(\n        distDir,\n        false,\n        (config.experimental.turbotrace?.memoryLimit ??\n          TURBO_TRACE_DEFAULT_MEMORY_LIMIT) *\n          1024 *\n          1024\n      )\n\n      const { entriesTrace, chunksTrace } = buildTraceContext\n      if (entriesTrace) {\n        const {\n          appDir: buildTraceContextAppDir,\n          depModArray,\n          entryNameMap,\n          outputPath,\n          action,\n        } = entriesTrace\n        const depModSet = new Set(depModArray)\n        const filesTracedInEntries: string[] = await bindings.turbo.startTrace(\n          action,\n          turboTasksForTrace\n        )\n\n        const { contextDirectory, input: entriesToTrace } = action\n\n        // only trace the assets under the appDir\n        // exclude files from node_modules, entries and processed by webpack\n        const filesTracedFromEntries = filesTracedInEntries\n          .map((f) => path.join(contextDirectory, f))\n          .filter(\n            (f) =>\n              !f.includes('/node_modules/') &&\n              f.startsWith(buildTraceContextAppDir) &&\n              !entriesToTrace.includes(f) &&\n              !depModSet.has(f)\n          )\n        if (filesTracedFromEntries.length) {\n          // The turbo trace doesn't provide the traced file type and reason at present\n          // let's write the traced files into the first [entry].nft.json\n          const [[, entryName]] = Array.from<[string, string]>(\n            Object.entries(entryNameMap)\n          ).filter(([k]) => k.startsWith(buildTraceContextAppDir))\n          const traceOutputPath = path.join(\n            outputPath,\n            `../${entryName}.js.nft.json`\n          )\n          const traceOutputDir = path.dirname(traceOutputPath)\n\n          turbotraceOutputPath = traceOutputPath\n          turbotraceFiles = filesTracedFromEntries.map((file) =>\n            path.relative(traceOutputDir, file)\n          )\n        }\n      }\n      if (chunksTrace) {\n        const { action, outputPath } = chunksTrace\n        action.input = action.input.filter((f: any) => {\n          const outputPagesPath = path.join(outputPath, '..', 'pages')\n          return (\n            !f.startsWith(outputPagesPath) ||\n            !staticPages.includes(\n              // strip `outputPagesPath` and file ext from absolute\n              f.substring(outputPagesPath.length, f.length - 3)\n            )\n          )\n        })\n        await bindings.turbo.startTrace(action, turboTasksForTrace)\n        if (turbotraceOutputPath && turbotraceFiles) {\n          const existedNftFile = await fs\n            .readFile(turbotraceOutputPath, 'utf8')\n            .then((existedContent) => JSON.parse(existedContent))\n            .catch(() => ({\n              version: TRACE_OUTPUT_VERSION,\n              files: [],\n            }))\n          existedNftFile.files.push(...turbotraceFiles)\n          const filesSet = new Set(existedNftFile.files)\n          existedNftFile.files = [...filesSet]\n          await fs.writeFile(\n            turbotraceOutputPath,\n            JSON.stringify(existedNftFile),\n            'utf8'\n          )\n        }\n      }\n    }\n  }\n\n  const { outputFileTracingIncludes = {}, outputFileTracingExcludes = {} } =\n    config\n  const excludeGlobKeys = Object.keys(outputFileTracingExcludes)\n  const includeGlobKeys = Object.keys(outputFileTracingIncludes)\n\n  await nextBuildSpan\n    .traceChild('node-file-trace-build', {\n      isTurbotrace: Boolean(config.experimental.turbotrace) ? 'true' : 'false',\n    })\n    .traceAsyncFn(async () => {\n      const nextServerTraceOutput = path.join(\n        distDir,\n        'next-server.js.nft.json'\n      )\n      const nextMinimalTraceOutput = path.join(\n        distDir,\n        'next-minimal-server.js.nft.json'\n      )\n      const root =\n        config.experimental?.turbotrace?.contextDirectory ??\n        outputFileTracingRoot\n\n      // Under standalone mode, we need to trace the extra IPC server and\n      // worker files.\n      const isStandalone = config.output === 'standalone'\n      const nextServerEntry = require.resolve('next/dist/server/next-server')\n      const sharedEntriesSet = [\n        ...(config.experimental.turbotrace\n          ? []\n          : Object.keys(defaultOverrides).map((value) =>\n              require.resolve(value, {\n                paths: [require.resolve('next/dist/server/require-hook')],\n              })\n            )),\n      ]\n\n      const { cacheHandler } = config\n      const { cacheHandlers } = config.experimental\n\n      // ensure we trace any dependencies needed for custom\n      // incremental cache handler\n      if (cacheHandler) {\n        sharedEntriesSet.push(\n          require.resolve(\n            path.isAbsolute(cacheHandler)\n              ? cacheHandler\n              : path.join(dir, cacheHandler)\n          )\n        )\n      }\n\n      if (cacheHandlers) {\n        for (const handlerPath of Object.values(cacheHandlers)) {\n          if (handlerPath) {\n            sharedEntriesSet.push(\n              require.resolve(\n                path.isAbsolute(handlerPath)\n                  ? handlerPath\n                  : path.join(dir, handlerPath)\n              )\n            )\n          }\n        }\n      }\n\n      const serverEntries = [\n        ...sharedEntriesSet,\n        ...(isStandalone\n          ? [\n              require.resolve('next/dist/server/lib/start-server'),\n              require.resolve('next/dist/server/next'),\n              require.resolve('next/dist/server/require-hook'),\n            ]\n          : []),\n        require.resolve('next/dist/server/next-server'),\n      ].filter(Boolean) as string[]\n\n      const minimalServerEntries = [\n        ...sharedEntriesSet,\n        require.resolve('next/dist/compiled/next-server/server.runtime.prod'),\n      ].filter(Boolean)\n\n      const additionalIgnores = new Set<string>()\n\n      for (const glob of excludeGlobKeys) {\n        if (picomatch(glob)('next-server')) {\n          outputFileTracingExcludes[glob].forEach((exclude) => {\n            additionalIgnores.add(exclude)\n          })\n        }\n      }\n\n      const makeIgnoreFn = (ignores: string[]) => {\n        // pre compile the ignore globs\n        const isMatch = picomatch(ignores, {\n          contains: true,\n          dot: true,\n        })\n\n        return (pathname: string) => {\n          if (path.isAbsolute(pathname) && !pathname.startsWith(root)) {\n            return true\n          }\n\n          return isMatch(pathname)\n        }\n      }\n\n      const sharedIgnores = [\n        '**/next/dist/compiled/next-server/**/*.dev.js',\n        ...(isStandalone ? [] : ['**/next/dist/compiled/jest-worker/**/*']),\n        '**/next/dist/compiled/webpack/(bundle4|bundle5).js',\n        '**/node_modules/webpack5/**/*',\n        '**/next/dist/server/lib/route-resolver*',\n        'next/dist/compiled/semver/semver/**/*.js',\n\n        ...(ciEnvironment.hasNextSupport\n          ? [\n              // only ignore image-optimizer code when\n              // this is being handled outside of next-server\n              '**/next/dist/server/image-optimizer.js',\n            ]\n          : []),\n\n        ...(!hasSsrAmpPages\n          ? ['**/next/dist/compiled/@ampproject/toolbox-optimizer/**/*']\n          : []),\n\n        ...(isStandalone ? [] : TRACE_IGNORES),\n        ...additionalIgnores,\n      ]\n\n      const sharedIgnoresFn = makeIgnoreFn(sharedIgnores)\n\n      const serverIgnores = [\n        ...sharedIgnores,\n        '**/node_modules/react{,-dom,-dom-server-turbopack}/**/*.development.js',\n        '**/*.d.ts',\n        '**/*.map',\n        '**/next/dist/pages/**/*',\n        ...(ciEnvironment.hasNextSupport\n          ? ['**/node_modules/sharp/**/*', '**/@img/sharp-libvips*/**/*']\n          : []),\n      ].filter(nonNullable)\n      const serverIgnoreFn = makeIgnoreFn(serverIgnores)\n\n      const minimalServerIgnores = [\n        ...serverIgnores,\n        '**/next/dist/compiled/edge-runtime/**/*',\n        '**/next/dist/server/web/sandbox/**/*',\n        '**/next/dist/server/post-process.js',\n      ]\n      const minimalServerIgnoreFn = makeIgnoreFn(minimalServerIgnores)\n\n      const routesIgnores = [\n        ...sharedIgnores,\n        // server chunks are provided via next-trace-entrypoints-plugin plugin\n        // as otherwise all chunks are traced here and included for all pages\n        // whether they are needed or not\n        '**/.next/server/chunks/**',\n        '**/next/dist/server/optimize-amp.js',\n        '**/next/dist/server/post-process.js',\n      ].filter(nonNullable)\n\n      const routeIgnoreFn = makeIgnoreFn(routesIgnores)\n\n      const traceContext = path.join(nextServerEntry, '..', '..')\n      const serverTracedFiles = new Set<string>()\n      const minimalServerTracedFiles = new Set<string>()\n\n      function addToTracedFiles(base: string, file: string, dest: Set<string>) {\n        dest.add(\n          path.relative(distDir, path.join(base, file)).replace(/\\\\/g, '/')\n        )\n      }\n\n      if (isStandalone) {\n        addToTracedFiles(\n          '',\n          require.resolve('next/dist/compiled/jest-worker/processChild'),\n          serverTracedFiles\n        )\n        addToTracedFiles(\n          '',\n          require.resolve('next/dist/compiled/jest-worker/threadChild'),\n          serverTracedFiles\n        )\n      }\n\n      if (config.experimental.turbotrace) {\n        await runTurbotrace()\n\n        const startTrace = bindings.turbo.startTrace\n        const makeTrace = async (entries: string[]) =>\n          startTrace(\n            {\n              action: 'print',\n              input: entries,\n              contextDirectory: traceContext,\n              logLevel: config.experimental.turbotrace?.logLevel,\n              processCwd: config.experimental.turbotrace?.processCwd,\n              logDetail: config.experimental.turbotrace?.logDetail,\n              showAll: config.experimental.turbotrace?.logAll,\n            },\n            turboTasksForTrace\n          )\n\n        // turbotrace does not handle concurrent tracing\n        const vanillaFiles = await makeTrace(serverEntries)\n        const minimalFiles = await makeTrace(minimalServerEntries)\n\n        for (const [set, files] of [\n          [serverTracedFiles, vanillaFiles],\n          [minimalServerTracedFiles, minimalFiles],\n        ] as [Set<string>, string[]][]) {\n          for (const file of files) {\n            if (\n              !(\n                set === minimalServerTracedFiles\n                  ? minimalServerIgnoreFn\n                  : serverIgnoreFn\n              )(path.join(traceContext, file))\n            ) {\n              addToTracedFiles(traceContext, file, set)\n            }\n          }\n        }\n      } else {\n        const chunksToTrace: string[] = [\n          ...(buildTraceContext?.chunksTrace?.action.input || []),\n          ...serverEntries,\n          ...minimalServerEntries,\n        ]\n        const result = await nodeFileTrace(chunksToTrace, {\n          base: outputFileTracingRoot,\n          processCwd: dir,\n          mixedModules: true,\n          async readFile(p) {\n            try {\n              return await fs.readFile(p, 'utf8')\n            } catch (e) {\n              if (isError(e) && (e.code === 'ENOENT' || e.code === 'EISDIR')) {\n                // since tracing runs in parallel with static generation server\n                // files might be removed from that step so tolerate ENOENT\n                // errors gracefully\n                return ''\n              }\n              throw e\n            }\n          },\n          async readlink(p) {\n            try {\n              return await fs.readlink(p)\n            } catch (e) {\n              if (\n                isError(e) &&\n                (e.code === 'EINVAL' ||\n                  e.code === 'ENOENT' ||\n                  e.code === 'UNKNOWN')\n              ) {\n                return null\n              }\n              throw e\n            }\n          },\n          async stat(p) {\n            try {\n              return await fs.stat(p)\n            } catch (e) {\n              if (isError(e) && (e.code === 'ENOENT' || e.code === 'ENOTDIR')) {\n                return null\n              }\n              throw e\n            }\n          },\n          // handle shared ignores at top-level as it\n          // avoids over-tracing when we don't need to\n          // and speeds up total trace time\n          ignore(p) {\n            if (sharedIgnoresFn(p)) {\n              return true\n            }\n\n            // if a chunk is attempting to be traced that isn't\n            // in our initial list we need to ignore it to prevent\n            // over tracing as webpack needs to be the source of\n            // truth for which chunks should be included for each entry\n            if (\n              p.includes('.next/server/chunks') &&\n              !chunksToTrace.includes(path.join(outputFileTracingRoot, p))\n            ) {\n              return true\n            }\n            return false\n          },\n        })\n        const reasons = result.reasons\n        const fileList = result.fileList\n        for (const file of result.esmFileList) {\n          fileList.add(file)\n        }\n\n        const parentFilesMap = getFilesMapFromReasons(fileList, reasons)\n        const cachedLookupIgnore = new Map<string, boolean>()\n        const cachedLookupIgnoreMinimal = new Map<string, boolean>()\n\n        for (const [entries, tracedFiles] of [\n          [serverEntries, serverTracedFiles],\n          [minimalServerEntries, minimalServerTracedFiles],\n        ] as Array<[string[], Set<string>]>) {\n          for (const file of entries) {\n            const curFiles = [\n              ...(parentFilesMap\n                .get(path.relative(outputFileTracingRoot, file))\n                ?.keys() || []),\n            ]\n            tracedFiles.add(path.relative(distDir, file).replace(/\\\\/g, '/'))\n\n            for (const curFile of curFiles || []) {\n              const filePath = path.join(outputFileTracingRoot, curFile)\n\n              if (\n                !shouldIgnore(\n                  curFile,\n                  tracedFiles === minimalServerTracedFiles\n                    ? minimalServerIgnoreFn\n                    : serverIgnoreFn,\n                  reasons,\n                  tracedFiles === minimalServerTracedFiles\n                    ? cachedLookupIgnoreMinimal\n                    : cachedLookupIgnore\n                )\n              ) {\n                tracedFiles.add(\n                  path.relative(distDir, filePath).replace(/\\\\/g, '/')\n                )\n              }\n            }\n          }\n        }\n\n        const { entryNameFilesMap } = buildTraceContext?.chunksTrace || {}\n\n        const cachedLookupIgnoreRoutes = new Map<string, boolean>()\n\n        await Promise.all(\n          [\n            ...(entryNameFilesMap\n              ? Object.entries(entryNameFilesMap)\n              : new Map()),\n          ].map(async ([entryName, entryNameFiles]) => {\n            const isApp = entryName.startsWith('app/')\n            const isPages = entryName.startsWith('pages/')\n            let route = entryName\n            if (isApp) {\n              route = normalizeAppPath(route.substring('app'.length))\n            }\n            if (isPages) {\n              route = normalizePagePath(route.substring('pages'.length))\n            }\n\n            // we don't need to trace for automatically statically optimized\n            // pages as they don't have server bundles, note there is\n            // the caveat with flying shuttle mode as it needs this for\n            // detecting changed entries\n            if (staticPages.includes(route) && !isFlyingShuttle) {\n              return\n            }\n            const entryOutputPath = path.join(\n              distDir,\n              'server',\n              `${entryName}.js`\n            )\n            const traceOutputPath = `${entryOutputPath}.nft.json`\n            const existingTrace = JSON.parse(\n              await fs.readFile(traceOutputPath, 'utf8')\n            ) as {\n              version: number\n              files: string[]\n              fileHashes: Record<string, string>\n            }\n            const traceOutputDir = path.dirname(traceOutputPath)\n            const curTracedFiles = new Set<string>()\n            const curFileHashes: Record<string, string> =\n              existingTrace.fileHashes\n\n            for (const file of [...entryNameFiles, entryOutputPath]) {\n              const curFiles = [\n                ...(parentFilesMap\n                  .get(path.relative(outputFileTracingRoot, file))\n                  ?.keys() || []),\n              ]\n              for (const curFile of curFiles || []) {\n                if (\n                  !shouldIgnore(\n                    curFile,\n                    routeIgnoreFn,\n                    reasons,\n                    cachedLookupIgnoreRoutes\n                  )\n                ) {\n                  const filePath = path.join(outputFileTracingRoot, curFile)\n                  const outputFile = path\n                    .relative(traceOutputDir, filePath)\n                    .replace(/\\\\/g, '/')\n                  curTracedFiles.add(outputFile)\n\n                  if (isFlyingShuttle) {\n                    try {\n                      let hash = hashCache[filePath]\n\n                      if (!hash) {\n                        hash = getHash(await fs.readFile(filePath))\n                      }\n                      curFileHashes[outputFile] = hash\n                    } catch (err: any) {\n                      // handle symlink errors or similar\n                    }\n                  }\n                }\n              }\n            }\n\n            for (const file of existingTrace.files || []) {\n              curTracedFiles.add(file)\n            }\n\n            await fs.writeFile(\n              traceOutputPath,\n              JSON.stringify({\n                ...existingTrace,\n                files: [...curTracedFiles].sort(),\n                ...(isFlyingShuttle\n                  ? {\n                      fileHashes: curFileHashes,\n                    }\n                  : {}),\n              })\n            )\n          })\n        )\n      }\n\n      const moduleTypes = ['app-page', 'pages']\n\n      for (const type of moduleTypes) {\n        const modulePath = require.resolve(\n          `next/dist/server/route-modules/${type}/module.compiled`\n        )\n        const relativeModulePath = path.relative(root, modulePath)\n\n        const contextDir = path.join(\n          path.dirname(modulePath),\n          'vendored',\n          'contexts'\n        )\n\n        for (const item of await fs.readdir(contextDir)) {\n          const itemPath = path.relative(root, path.join(contextDir, item))\n          if (!serverIgnoreFn(itemPath)) {\n            addToTracedFiles(root, itemPath, serverTracedFiles)\n            addToTracedFiles(root, itemPath, minimalServerTracedFiles)\n          }\n        }\n        addToTracedFiles(root, relativeModulePath, serverTracedFiles)\n        addToTracedFiles(root, relativeModulePath, minimalServerTracedFiles)\n      }\n\n      await Promise.all([\n        fs.writeFile(\n          nextServerTraceOutput,\n          JSON.stringify({\n            version: 1,\n            files: Array.from(serverTracedFiles),\n          } as {\n            version: number\n            files: string[]\n          })\n        ),\n        fs.writeFile(\n          nextMinimalTraceOutput,\n          JSON.stringify({\n            version: 1,\n            files: Array.from(minimalServerTracedFiles),\n          } as {\n            version: number\n            files: string[]\n          })\n        ),\n      ])\n    })\n\n  // apply outputFileTracingIncludes/outputFileTracingExcludes after runTurbotrace\n  const includeExcludeSpan = nextBuildSpan.traceChild('apply-include-excludes')\n  await includeExcludeSpan.traceAsyncFn(async () => {\n    const globOrig =\n      require('next/dist/compiled/glob') as typeof import('next/dist/compiled/glob')\n    const glob = (pattern: string): Promise<string[]> => {\n      return new Promise((resolve, reject) => {\n        globOrig(\n          pattern,\n          { cwd: dir, nodir: true, dot: true },\n          (err, files) => {\n            if (err) {\n              return reject(err)\n            }\n            resolve(files)\n          }\n        )\n      })\n    }\n\n    const { entryNameFilesMap } = buildTraceContext?.chunksTrace || {}\n\n    await Promise.all(\n      [\n        ...(entryNameFilesMap ? Object.entries(entryNameFilesMap) : new Map()),\n      ].map(async ([entryName]) => {\n        const isApp = entryName.startsWith('app/')\n        const isPages = entryName.startsWith('pages/')\n        let route = entryName\n        if (isApp) {\n          route = normalizeAppPath(entryName)\n        }\n        if (isPages) {\n          route = normalizePagePath(entryName)\n        }\n\n        if (staticPages.includes(route)) {\n          return\n        }\n\n        // edge routes have no trace files\n        if (edgeRuntimeRoutes.hasOwnProperty(route)) {\n          return\n        }\n\n        const combinedIncludes = new Set<string>()\n        const combinedExcludes = new Set<string>()\n        for (const curGlob of includeGlobKeys) {\n          const isMatch = picomatch(curGlob, { dot: true, contains: true })\n          if (isMatch(route)) {\n            for (const include of outputFileTracingIncludes[curGlob]) {\n              combinedIncludes.add(include.replace(/\\\\/g, '/'))\n            }\n          }\n        }\n\n        for (const curGlob of excludeGlobKeys) {\n          const isMatch = picomatch(curGlob, { dot: true, contains: true })\n          if (isMatch(route)) {\n            for (const exclude of outputFileTracingExcludes[curGlob]) {\n              combinedExcludes.add(exclude)\n            }\n          }\n        }\n\n        if (!combinedIncludes?.size && !combinedExcludes?.size) {\n          return\n        }\n\n        const traceFile = path.join(\n          distDir,\n          `server`,\n          `${entryName}.js.nft.json`\n        )\n        const pageDir = path.dirname(traceFile)\n        const traceContent = JSON.parse(await fs.readFile(traceFile, 'utf8'))\n        const includes: string[] = []\n        const resolvedTraceIncludes = new Map<string, string[]>()\n\n        if (combinedIncludes?.size) {\n          await Promise.all(\n            [...combinedIncludes].map(async (includeGlob) => {\n              const results = await glob(includeGlob)\n              const resolvedInclude = resolvedTraceIncludes.get(\n                includeGlob\n              ) || [\n                ...results.map((file) => {\n                  return path.relative(pageDir, path.join(dir, file))\n                }),\n              ]\n              includes.push(...resolvedInclude)\n              resolvedTraceIncludes.set(includeGlob, resolvedInclude)\n            })\n          )\n        }\n        const combined = new Set([...traceContent.files, ...includes])\n\n        if (combinedExcludes?.size) {\n          const resolvedGlobs = [...combinedExcludes].map((exclude) =>\n            path.join(dir, exclude)\n          )\n\n          // pre compile before forEach\n          const isMatch = picomatch(resolvedGlobs, {\n            dot: true,\n            contains: true,\n          })\n\n          combined.forEach((file) => {\n            if (isMatch(path.join(pageDir, file))) {\n              combined.delete(file)\n            }\n          })\n        }\n\n        // overwrite trace file with custom includes/excludes\n        await fs.writeFile(\n          traceFile,\n          JSON.stringify({\n            version: traceContent.version,\n            files: [...combined],\n          })\n        )\n      })\n    )\n  })\n\n  debug(`finished build tracing ${Date.now() - startTime}ms`)\n}\n"],"names":["collectBuildTraces","debug","debugOriginal","hashCache","shouldIgnore","file","serverIgnoreFn","reasons","cachedIgnoreFiles","children","Set","has","get","set","add","reason","parents","size","type","includes","allParentsIgnored","parent","values","dir","config","distDir","edgeRuntimeRoutes","staticPages","nextBuildSpan","Span","name","hasSsrAmpPages","buildTraceContext","outputFileTracingRoot","isFlyingShuttle","startTime","Date","now","turboTasksForTrace","bindings","loadBindings","runTurbotrace","experimental","turbotrace","isWasm","turbo","startTrace","turbotraceOutputPath","turbotraceFiles","createTurboTasks","memoryLimit","TURBO_TRACE_DEFAULT_MEMORY_LIMIT","entriesTrace","chunksTrace","appDir","buildTraceContextAppDir","depModArray","entryNameMap","outputPath","action","depModSet","filesTracedInEntries","contextDirectory","input","entriesToTrace","filesTracedFromEntries","map","f","path","join","filter","startsWith","length","entryName","Array","from","Object","entries","k","traceOutputPath","traceOutputDir","dirname","relative","outputPagesPath","substring","existedNftFile","fs","readFile","then","existedContent","JSON","parse","catch","version","TRACE_OUTPUT_VERSION","files","push","filesSet","writeFile","stringify","outputFileTracingIncludes","outputFileTracingExcludes","excludeGlobKeys","keys","includeGlobKeys","traceChild","isTurbotrace","Boolean","traceAsyncFn","nextServerTraceOutput","nextMinimalTraceOutput","root","isStandalone","output","nextServerEntry","require","resolve","sharedEntriesSet","defaultOverrides","value","paths","cacheHandler","cacheHandlers","isAbsolute","handlerPath","serverEntries","minimalServerEntries","additionalIgnores","glob","picomatch","forEach","exclude","makeIgnoreFn","ignores","isMatch","contains","dot","pathname","sharedIgnores","ciEnvironment","hasNextSupport","TRACE_IGNORES","sharedIgnoresFn","serverIgnores","nonNullable","minimalServerIgnores","minimalServerIgnoreFn","routesIgnores","routeIgnoreFn","traceContext","serverTracedFiles","minimalServerTracedFiles","addToTracedFiles","base","dest","replace","makeTrace","logLevel","processCwd","logDetail","showAll","logAll","vanillaFiles","minimalFiles","chunksToTrace","result","nodeFileTrace","mixedModules","p","e","isError","code","readlink","stat","ignore","fileList","esmFileList","parentFilesMap","getFilesMapFromReasons","cachedLookupIgnore","Map","cachedLookupIgnoreMinimal","tracedFiles","curFiles","curFile","filePath","entryNameFilesMap","cachedLookupIgnoreRoutes","Promise","all","entryNameFiles","isApp","isPages","route","normalizeAppPath","normalizePagePath","entryOutputPath","existingTrace","curTracedFiles","curFileHashes","fileHashes","outputFile","hash","getHash","err","sort","moduleTypes","modulePath","relativeModulePath","contextDir","item","readdir","itemPath","includeExcludeSpan","globOrig","pattern","reject","cwd","nodir","hasOwnProperty","combinedIncludes","combinedExcludes","curGlob","include","traceFile","pageDir","traceContent","resolvedTraceIncludes","includeGlob","results","resolvedInclude","combined","resolvedGlobs","delete"],"mappings":"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"}