{"version":3,"sources":["../../../../src/build/webpack/loaders/utils.ts"],"sourcesContent":["import type webpack from 'webpack'\nimport { createHash } from 'crypto'\nimport { RSC_MODULE_TYPES } from '../../../shared/lib/constants'\n\nconst imageExtensions = ['jpg', 'jpeg', 'png', 'webp', 'avif', 'ico', 'svg']\nconst imageRegex = new RegExp(`\\\\.(${imageExtensions.join('|')})$`)\n\n// Determine if the whole module is client action, 'use server' in nested closure in the client module\nfunction isActionClientLayerModule(mod: { resource: string; buildInfo?: any }) {\n  const rscInfo = mod.buildInfo.rsc\n  return !!(rscInfo?.actions && rscInfo?.type === RSC_MODULE_TYPES.client)\n}\n\nexport function isClientComponentEntryModule(mod: {\n  resource: string\n  buildInfo?: any\n}) {\n  const rscInfo = mod.buildInfo.rsc\n  const hasClientDirective = rscInfo?.isClientRef\n  const isActionLayerEntry = isActionClientLayerModule(mod)\n  return (\n    hasClientDirective || isActionLayerEntry || imageRegex.test(mod.resource)\n  )\n}\n\nexport const regexCSS = /\\.(css|scss|sass)(\\?.*)?$/\n\n// This function checks if a module is able to emit CSS resources. You should\n// never only rely on a single regex to do that.\nexport function isCSSMod(mod: {\n  resource: string\n  type?: string\n  loaders?: { loader: string }[]\n}): boolean {\n  return !!(\n    mod.type === 'css/mini-extract' ||\n    (mod.resource && regexCSS.test(mod.resource)) ||\n    mod.loaders?.some(\n      ({ loader }) =>\n        loader.includes('next-style-loader/index.js') ||\n        loader.includes('mini-css-extract-plugin/loader.js') ||\n        loader.includes('@vanilla-extract/webpack-plugin/loader/')\n    )\n  )\n}\n\nexport function getActionsFromBuildInfo(mod: {\n  resource: string\n  buildInfo?: any\n}): undefined | string[] {\n  return mod.buildInfo?.rsc?.actions\n}\n\nexport function generateActionId(\n  hashSalt: string,\n  filePath: string,\n  exportName: string\n) {\n  return createHash('sha1')\n    .update(hashSalt + filePath + ':' + exportName)\n    .digest('hex')\n}\n\nexport function encodeToBase64<T extends {}>(obj: T): string {\n  return Buffer.from(JSON.stringify(obj)).toString('base64')\n}\n\nexport function decodeFromBase64<T extends {}>(str: string): T {\n  return JSON.parse(Buffer.from(str, 'base64').toString('utf8'))\n}\n\nexport async function getLoaderModuleNamedExports(\n  resourcePath: string,\n  context: webpack.LoaderContext<any>\n): Promise<string[]> {\n  const mod = await new Promise<webpack.NormalModule>((res, rej) => {\n    context.loadModule(\n      resourcePath,\n      (err: null | Error, _source: any, _sourceMap: any, module: any) => {\n        if (err) {\n          return rej(err)\n        }\n        res(module)\n      }\n    )\n  })\n\n  const exportNames =\n    mod.dependencies\n      ?.filter((dep) => {\n        return (\n          [\n            'HarmonyExportImportedSpecifierDependency',\n            'HarmonyExportSpecifierDependency',\n          ].includes(dep.constructor.name) &&\n          'name' in dep &&\n          dep.name !== 'default'\n        )\n      })\n      .map((dep: any) => {\n        return dep.name\n      }) || []\n  return exportNames\n}\n"],"names":["decodeFromBase64","encodeToBase64","generateActionId","getActionsFromBuildInfo","getLoaderModuleNamedExports","isCSSMod","isClientComponentEntryModule","regexCSS","imageExtensions","imageRegex","RegExp","join","isActionClientLayerModule","mod","rscInfo","buildInfo","rsc","actions","type","RSC_MODULE_TYPES","client","hasClientDirective","isClientRef","isActionLayerEntry","test","resource","loaders","some","loader","includes","hashSalt","filePath","exportName","createHash","update","digest","obj","Buffer","from","JSON","stringify","toString","str","parse","resourcePath","context","Promise","res","rej","loadModule","err","_source","_sourceMap","module","exportNames","dependencies","filter","dep","constructor","name","map"],"mappings":";;;;;;;;;;;;;;;;;;;;;IAmEgBA,gBAAgB;eAAhBA;;IAJAC,cAAc;eAAdA;;IAVAC,gBAAgB;eAAhBA;;IAPAC,uBAAuB;eAAvBA;;IAyBMC,2BAA2B;eAA3BA;;IA1CNC,QAAQ;eAARA;;IAhBAC,4BAA4B;eAA5BA;;IAYHC,QAAQ;eAARA;;;wBAxBc;2BACM;AAEjC,MAAMC,kBAAkB;IAAC;IAAO;IAAQ;IAAO;IAAQ;IAAQ;IAAO;CAAM;AAC5E,MAAMC,aAAa,IAAIC,OAAO,CAAC,IAAI,EAAEF,gBAAgBG,IAAI,CAAC,KAAK,EAAE,CAAC;AAElE,sGAAsG;AACtG,SAASC,0BAA0BC,GAA0C;IAC3E,MAAMC,UAAUD,IAAIE,SAAS,CAACC,GAAG;IACjC,OAAO,CAAC,CAAEF,CAAAA,CAAAA,2BAAAA,QAASG,OAAO,KAAIH,CAAAA,2BAAAA,QAASI,IAAI,MAAKC,2BAAgB,CAACC,MAAM,AAAD;AACxE;AAEO,SAASd,6BAA6BO,GAG5C;IACC,MAAMC,UAAUD,IAAIE,SAAS,CAACC,GAAG;IACjC,MAAMK,qBAAqBP,2BAAAA,QAASQ,WAAW;IAC/C,MAAMC,qBAAqBX,0BAA0BC;IACrD,OACEQ,sBAAsBE,sBAAsBd,WAAWe,IAAI,CAACX,IAAIY,QAAQ;AAE5E;AAEO,MAAMlB,WAAW;AAIjB,SAASF,SAASQ,GAIxB;QAIGA;IAHF,OAAO,CAAC,CACNA,CAAAA,IAAIK,IAAI,KAAK,sBACZL,IAAIY,QAAQ,IAAIlB,SAASiB,IAAI,CAACX,IAAIY,QAAQ,OAC3CZ,eAAAA,IAAIa,OAAO,qBAAXb,aAAac,IAAI,CACf,CAAC,EAAEC,MAAM,EAAE,GACTA,OAAOC,QAAQ,CAAC,iCAChBD,OAAOC,QAAQ,CAAC,wCAChBD,OAAOC,QAAQ,CAAC,4CACpB;AAEJ;AAEO,SAAS1B,wBAAwBU,GAGvC;QACQA,oBAAAA;IAAP,QAAOA,iBAAAA,IAAIE,SAAS,sBAAbF,qBAAAA,eAAeG,GAAG,qBAAlBH,mBAAoBI,OAAO;AACpC;AAEO,SAASf,iBACd4B,QAAgB,EAChBC,QAAgB,EAChBC,UAAkB;IAElB,OAAOC,IAAAA,kBAAU,EAAC,QACfC,MAAM,CAACJ,WAAWC,WAAW,MAAMC,YACnCG,MAAM,CAAC;AACZ;AAEO,SAASlC,eAA6BmC,GAAM;IACjD,OAAOC,OAAOC,IAAI,CAACC,KAAKC,SAAS,CAACJ,MAAMK,QAAQ,CAAC;AACnD;AAEO,SAASzC,iBAA+B0C,GAAW;IACxD,OAAOH,KAAKI,KAAK,CAACN,OAAOC,IAAI,CAACI,KAAK,UAAUD,QAAQ,CAAC;AACxD;AAEO,eAAerC,4BACpBwC,YAAoB,EACpBC,OAAmC;QAejChC;IAbF,MAAMA,MAAM,MAAM,IAAIiC,QAA8B,CAACC,KAAKC;QACxDH,QAAQI,UAAU,CAChBL,cACA,CAACM,KAAmBC,SAAcC,YAAiBC;YACjD,IAAIH,KAAK;gBACP,OAAOF,IAAIE;YACb;YACAH,IAAIM;QACN;IAEJ;IAEA,MAAMC,cACJzC,EAAAA,oBAAAA,IAAI0C,YAAY,qBAAhB1C,kBACI2C,MAAM,CAAC,CAACC;QACR,OACE;YACE;YACA;SACD,CAAC5B,QAAQ,CAAC4B,IAAIC,WAAW,CAACC,IAAI,KAC/B,UAAUF,OACVA,IAAIE,IAAI,KAAK;IAEjB,GACCC,GAAG,CAAC,CAACH;QACJ,OAAOA,IAAIE,IAAI;IACjB,OAAM,EAAE;IACZ,OAAOL;AACT"}